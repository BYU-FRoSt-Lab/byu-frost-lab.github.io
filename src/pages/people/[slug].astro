---
import PageLayout from '~/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';
import { Image } from 'astro:assets';

const photoImports = ((import.meta as any).glob(
  '../../assets/images/people/**/*.{jpg,jpeg,png,webp,avif}',
  { eager: true },
) as Record<string, any>);

function resolvePhoto(photo) {
  if (!photo) return photo;
  // Convert frontmatter string paths to the glob key so Astro can serve optimized assets.
  const key = photo.replace(/^\/?\bsrc\//, '../../');
  return photoImports[key]?.default ?? photo;
}

export async function getStaticPaths() {
  const modules = (import.meta.glob('../../content/people/*.md', { eager: true }) as any);
  return Object.keys(modules).map((path) => {
    const parts = path.split('/');
    const filename = parts[parts.length - 1];
    const slug = filename.replace(/\.md$/, '');
    return { params: { slug } };
  });
}

const modules = (import.meta.glob('../../content/people/*.md', { eager: true }) as any);
const people = Object.entries(modules).map(([path, mod]: [string, any]) => {
  const parts = path.split('/');
  const filename = parts[parts.length - 1];
  const slug = filename.replace(/\.md$/, '');
  return { slug, ...(mod.frontmatter || {}), photo: resolvePhoto(mod.frontmatter?.photo), Content: (mod as any).default };
});

const { slug } = Astro.params;
const person = people.find((p) => p.slug === slug);
if (!person) {
  throw new Error(`Person not found: ${slug}`);
}
const Content = person.Content;
const metadata = { title: `${person.name} | People | FROST Lab` };
---

<PageLayout metadata={metadata}>
  <section class="max-w-4xl mx-auto px-4 py-12">
    <a class="text-sm text-blue-600 mb-4 inline-block" href="/people">‚Üê Back to people</a>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
      <aside class="md:col-span-1">
        <div class="w-full aspect-square mx-auto md:mx-0 overflow-hidden rounded-lg">
          <Image
            src={person.photo}
            alt={person.name}
            class="w-full h-full object-cover"
            widths={[320, 640, 1024]}
            formats={['avif', 'webp', 'jpeg']}
            width={480}
            height={480}
          />
        </div>
        <h2 class="mt-4 text-2xl font-bold">{person.name}</h2>
        <p class="text-sm text-gray-500 mb-3">{person.title}</p>

        {person.links && person.links.length ? (
          <div class="space-y-2">
            {person.links.map((l) => {
              const url = l.url || '';
              const label = (l.label || 'link');
              let iconName = 'tabler:globe';
              const lname = label.toLowerCase();
              if (url.includes('github.com') || lname.includes('github')) iconName = 'tabler:brand-github';
              else if (url.includes('linkedin.com') || lname.includes('linkedin')) iconName = 'tabler:brand-linkedin';
              else if (url.includes('x.com') || url.includes('twitter.com') || lname.includes('twitter') || lname === 'x') iconName = 'tabler:brand-x';
              else if (url.startsWith('mailto:') || lname.includes('email')) iconName = 'tabler:mail';
              else if (lname.includes('cv') || lname.includes('resume')) iconName = 'tabler:file-cv';

              return (
                <a
                  href={url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center text-sm text-blue-600 hover:underline"
                >
                  <Icon name={iconName} class="w-4 h-4 mr-2" />
                  {label}
                </a>
              );
            })}
          </div>
        ) : null}
      </aside>

      <main class="md:col-span-2">
        <article class="prose prose-sm dark:prose-invert prose-a:text-accent prose-a:no-underline hover:prose-a:underline">
          <Content />
        </article>
      </main>
    </div>
  </section>
</PageLayout>
